#!/bin/sh
# This script launches the lemonbar with all the required modules.
# Default modules are:
#	CPU usage
#	RAM usage
#	e-mail (mutt) inbox
#	wi-fi connection
#	Volume information
#	Battery
#	Date & time

BGCOL="#2f343f"
#TODO: Implement font and font size
FONT="Noto Mono"

#TODO
#Right now this is just a token. We will implement the right solution once we implement bspwm
Workspaces(){
	printf "%%{+u}%%{U#aa0000}1%%{-u} %%{U#9999ff}2 %%{+u}3%%{-u} %%{+u}4%%{-u} 5"
}

# Print CPU usage and core temperature
Cpu(){
	cpu_usage=$(top -bn1 | grep "Cpu(s)" | grep -Po "(\d+[,\.]*\d*)(?=%* *id)" | awk '{print 100 - $1}')
	temp=$(sensors | awk '/Core 0/ {print $3}')
	printf "%%{U#f14d00}%%{A:cpu1:}%%{A3:cpu3:}%%{+u}CPU: $cpu_usage%%%% $temp%%{-u}%%{A}%%{A}"
}

# Print memory usage
Memory(){
	mem=$(free -h | awk '/^Mem:/ {print $3 "/" $2}')
	printf "%%{U#99f199}%%{A:mem1:}%%{A3:mem3:}%%{+u}RAM: $mem%%{-u}%%{A}%%{A}"
}

# Check if there are new mails in the local folder
Mail(){
	mails=$(ls $HOME/.local/share/mail/*/INBOX/new | sed '/\.local\/.*$/d' | sed '/^\s*$/d' | wc -l)
	[ $mails -gt 0 ] && printf "%%{U#0000aa}%%{A:mail1:}%%{+u}Correus: $mails%%{-u}%%{A} "
}

# Print a message if we are currently connected to the internet
Internet(){
	wstatus=""
	case $(cat /sys/class/net/w*/operstate) in
		down) wstatus="Sense connexió" ;;
		up) wstatus="Connectat" ;;
	esac
	printf "%%{A:int1:}%%{U#00aaaa}%%{+u}$wstatus%%{-u}%%{A}"
}

# Print the current volume and if it is muted
Volume(){
	vol_status="$(amixer get Master)"
	vol=$(echo "$vol_status" | grep "\[[0-9]\+%\]" | grep -Pom 1 "[0-9]+%")
	message=""
	case $vol_status in
		*\[off\]*) message="SIL ($vol%)" ;;
		*\[on\]*) message="VOL $vol%" ;;
	esac
	printf "%%{U#000044}%%{A:vol1:}%%{A3:vol3:}%%{A4:vol4:}%%{A5:vol5:}%%{+u}$message %%{-u}%%{A}%%{A}%%{A}%%{A}"
}

# Print the current battery percentage
Battery(){
	printf "%%{U#e3e300}%%{+u}Bat:$(acpi -b | grep -Po '[0-9]+%')%%%%%{-u}"
}

# Print the current date and time
Date(){
	printf "%%{U#aa00aa}%%{A:date1:}%%{+u}$(date '+%d %b %Y | %H:%M:%S')%%{-u}%%{A}"
}

while true; do echo "%{l}$(Workspaces) %{r}$(Cpu) $(Memory) $(Mail)$(Internet) $(Volume) $(Battery) $(Date) "; sleep 0.8; done | lemonbar -g 'x25' -B $BGCOL | while read line; do
	case $line in
		cpu1) notify-send "Processos CPU-intensius" "$(ps axch -o cmd:15,%cpu --sort=-%cpu | head)" ;;
		cpu3) notify-send "Mòdul de CPU" "\- Mostra l'ús de CPU i la temperatura del nucli.\n\- Clica per mostrar els processos que ocupen més temps del processador." ;;
		mem1) notify-send "Grans consumidors de memòria" "$(ps axch -o cmd:15,%mem --sort=-%mem | head)" ;;
		mem3) notify-send "Mòdul de memòria" "\- Mostra memòria usada/total.\n\- Clica per veure els processos que consumeixen més memòria." ;;
		mail1) $TERMINAL -e neomutt;;
		#mail3) notify-send "Mòdul de correu" "\- Mostra missatges sense llegir.\n\- Clica per obrir neomutt." ;;
		int1) $TERMINAL -e nmtui ;;
		#int3) notify-send "Mòdul d'internet" "\- Mostra si hi ha connexió a internet.\n\- Clica per editar la connexió." ;;
		vol1) pactl set-sink-mute 0 toggle ;;
		vol3) notify-send "Mòdul de volum" "\- Mostra el volum i si està silenciat.\n\- Clica per silenciar.\n\- Fes servir la roda del ratolí per pujar o baixar el volum." ;;
		vol4) pactl set-sink-volume 0 +2% ;;
		vol5) pactl set-sink-volume 0 -2% ;;
		#bat3) notify-send "Mòdul de bateria" "\- Mostra la càrrega actual." ;;
		date1) notify-send "$(ncal -M -bh)" ;;
		#date3) notify-send "Data i hora" "\- Mostra la data i hora actual.\n\- Clica per mostrar el calendari del mes actual." ;;
		*) ;;
	esac
done
