#!/bin/sh
# Turn on the lemonbar
# TODO: Adapt for multiple monitors (requires setting up several FIFOs)

# Refresh the pipe
[ -e "$LLIMA_FIFO" ] && rm "$LLIMA_FIFO"
mkfifo "$LLIMA_FIFO"
exec 3<> "$LLIMA_FIFO"

# Turn the modules on
bspc subscribe report > "$LLIMA_FIFO" &
DIR="$HOME/.local/bin/modules"
$DIR/battery > "$LLIMA_FIFO" &
$DIR/cpu > "$LLIMA_FIFO" &
$DIR/date > "$LLIMA_FIFO" &
$DIR/memory > "$LLIMA_FIFO" &
$DIR/wstat > "$LLIMA_FIFO" &
echo "V\nM" > "$LLIMA_FIFO"

# Import bar configuration
. $HOME/.local/share/global-style

# Get active monitors with their geometries
#MONITORS_LIST=$(xrandr | grep -w connected | sed 's/ primary//' | awk -F'[ \+]' '{print $1,$3,$4,$5}')
monitor=$(xrandr | grep -w connected | grep primary | sed 's/ primary//' | awk -F'[ \+]' '{print $1,$3,$4,$5}')

# Actual call
#IFS='
#'
#for monitor in $MONITORS_LIST; do
#	monitor_name=$(echo "$monitor" | cut -d ' ' -f 1)
	monitor_width=$(echo "$monitor" | cut -d ' ' -f 2 | cut -d 'x' -f 1)
	monitor_offset_x=$(echo "$monitor" | cut -d ' ' -f 3)
	bar_width=$(echo "$monitor_width" | awk '{print $1 - 20}')
	bar_offset_x=$(echo "$monitor_offset_x" | awk '{print $1 + 10}')
	bar-updater < "$LLIMA_FIFO" | lemonbar -a 32 -u 2 -g ${bar_width}x${BAR_HEIGHT}+${bar_offset_x}+5 -f "$BAR_FONT" -F "$COLOR_FOREGROUND" -B "$COLOR_BACKGROUND" -U "$COLOR_UNDERLINE" | sh &
#done

# Wait
wait
