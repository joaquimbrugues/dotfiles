#!/bin/sh
# Turn on the lemonbar

# Kill background procresses on exit
trap 'trap - TERM; kill 0' INT TERM QUIT EXIT

# Refresh the pipe
[ -e "$LLIMA_FIFO" ] && rm "$LLIMA_FIFO"
mkfifo "$LLIMA_FIFO"
exec 3<> "$LLIMA_FIFO"

# Turn the modules on
bspc subscribe report > "$LLIMA_FIFO" &
DIR="$HOME/.local/bin/modules"
$DIR/battery > "$LLIMA_FIFO" &
$DIR/cpu > "$LLIMA_FIFO" &
$DIR/date > "$LLIMA_FIFO" &
$DIR/memory > "$LLIMA_FIFO" &
$DIR/wstat > "$LLIMA_FIFO" &
echo "V\nM" > "$LLIMA_FIFO"

# Import bar configuration
. $HOME/.local/share/global-style

# Get active monitors with their geometries
monitor=$(xrandr | grep -w connected | grep primary | sed 's/ primary//' | awk -F'[ \+]' '{print $1,$3,$4,$5}')

# Actual call
monitor_width=$(echo "$monitor" | cut -d ' ' -f 2 | cut -d 'x' -f 1)
monitor_offset_x=$(echo "$monitor" | cut -d ' ' -f 3)
bar_width=$(echo "$monitor_width" | awk '{print $1 - 20}')
bar_offset_x=$(echo "$monitor_offset_x" | awk '{print $1 + 10}')
bar-updater < "$LLIMA_FIFO" | lemonbar -n "$LLIMA_NAME" -a 32 -u 2 -g ${bar_width}x${BAR_HEIGHT}+${bar_offset_x}+5 -f "$BAR_FONT" -F "$COLOR_FOREGROUND" -B "$COLOR_BACKGROUND" -U "$COLOR_UNDERLINE" | sh &

wid=$(xdo id -a "$LLIMA_NAME")
xdo above -t "$(xdo id -N Bspwm -n root | sort | head -n 1)" "$wid"

# Wait
wait
