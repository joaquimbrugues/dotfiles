#!/bin/sh
# Catch-all recording script with FFMPEG.
# There are several modes, and on call the user is asked to select one:
# - Mic only
# - Mic and computer audio (in separate files), useful to record conversations and such
# - Grab screen, either with audio or without

# Kill the current recording
mata() {
	while IFS= read -r pid; do kill -15 $pid; done < /tmp/recordpid
	echo "E" > $LLIMA_FIFO
	notify-send "üëå Fi de l'enregistrament!"
	sleep 3
	while IFS= read -r pid; do kill -9 $pid 2>/dev/null; done < /tmp/recordpid
	rm -f /tmp/recordpid
	exit 0
}

# Record the mic
audiomicro() {
	ffmpeg -loglevel quiet -y -f alsa -i default "$DIR/micro-$(date '+%y%m%d-%H%M-%S').wav" >/dev/null &
	echo "$!" > "/tmp/recordpid"
	echo "Eüéô" > $LLIMA_FIFO
	notify-send "üéô Enregistrant el micr√≤fon"
}

# Record the mic and the internal audio in separate files
audiodoble() {
	uid=$(date '+%y%m%d-%H%M-%S')
	#Micr√≤fon
	ffmpeg -loglevel quiet -y -f alsa -i default "$DIR/micro-${uid}.wav" >/dev/null &
	echo "$!" > "/tmp/recordpid"
	#√Äudio intern
	ffmpeg -loglevel quiet -y -f pulse -i 0 "$DIR/intern-${uid}.wav" >/dev/null &
	echo "$!" >> "/tmp/recordpid"
	echo "EüéôüëÇ" > $LLIMA_FIFO
	notify-send "üéôüëÇ Enregistrant el micr√≤fon i l'√†udio intern"
}

# Record the selected screen
pantalla() {
	tria=$(xrandr | grep -w connected | awk '{print $1}' | dmenu_col -c -l 10 -p "Tria un monitor (o tot per defecte)")
	if [ -z "$tria" ]; then
		ffmpeg -loglevel quiet -y -f x11grab -i :0.0 -c:v libx264 -r 24 "$DIR/pantalla-$(date '+%y%m%d-%H%M-%S').mkv" >/dev/null &
		echo "$!" > "/tmp/recordpid"
	else
		geometria=$(xrandr | grep "$tria" | sed -r 's/primary//' | awk '{print $3}')
		mida=$(echo "$geometria" | awk -F'+' '{print $1}')
		mov=$(echo "$geometria" | awk -F'+' '{print $2","$3}')
		ffmpeg -loglevel quiet -y -f x11grab -s "$mida" -i :0.0+"$mov" -c:v libx264 -r 24 "$DIR/pantalla-$(date '+%y%m%d-%H%M-%S').mkv" >/dev/null &
		echo "$!" > "/tmp/recordpid"
	fi
	echo "Eüìπ" > $LLIMA_FIFO
}

# Record the selected screen and the audio
pantallaiso() {
	uid=$(date '+%y%m%d-%H%M-%S')
	tria=$(xrandr | grep -w connected | awk '{print $1}' | dmenu_col -c -l 10 -p "Tria un monitor (o tot per defecte)")
	if [ -z "$tria" ]; then
		ffmpeg -loglevel quiet -y -f x11grab -i :0.0 -f alsa -i default -c:v libx264 -c:a flac -r 24 "$DIR/gravacio-${uid}.mkv" >/dev/null &
		echo "$!" > "/tmp/recordpid"
	else
		geometria=$(xrandr | grep "$tria" | sed -r 's/primary//' | awk '{print $3}')
		mida=$(echo "$geometria" | awk -F'+' '{print $1}')
		mov=$(echo "$geometria" | awk -F'+' '{print $2","$3}')
		ffmpeg -loglevel quiet -y -f x11grab -s "$mida" -i :0.0+"$mov" -f alsa -i default -c:v libx264 -c:a flac -r 24 "$DIR/gravacio-${uid}.mkv" >/dev/null &
		echo "$!" > "/tmp/recordpid"
	fi
	#√Äudio intern
	ffmpeg -loglevel quiet -y -f pulse -i 0 "$DIR/intern-${uid}.wav" >/dev/null &
	echo "$!" >> "/tmp/recordpid"
	echo "Eüìπüéô" > $LLIMA_FIFO
}

# Record the selected screen and the internal audio
pantallaisointern() {
	uid=$(date '+%y%m%d-%H%M-%S')
	tria=$(xrandr | grep -w connected | awk '{print $1}' | dmenu_col -c -l 10 -p "Tria un monitor (o tot per defecte)")
	if [ -z "$tria" ]; then
		ffmpeg -loglevel quiet -y -f x11grab -i :0.0 -f pulse -i 0 -c:v libx264 -c:a flac -r 24 "$DIR/gravacio-${uid}.mkv" >/dev/null &
		echo "$!" > "/tmp/recordpid"
	else
		geometria=$(xrandr | grep "$tria" | sed -r 's/primary//' | awk '{print $3}')
		mida=$(echo "$geometria" | awk -F'+' '{print $1}')
		mov=$(echo "$geometria" | awk -F'+' '{print $2","$3}')
		ffmpeg -loglevel quiet -y -f x11grab -s "$mida" -i :0.0+"$mov" -f pulse -i 0 -c:v libx264 -c:a flac -r 24 "$DIR/gravacio-${uid}.mkv" >/dev/null &
		echo "$!" > "/tmp/recordpid"
	fi
	echo "EüìπüëÇ" > $LLIMA_FIFO
}
# Ask for which recording mode to enter
pregunta() {
	tria=$(echo -e "Micr√≤fon\nDoble √†udio\nPantalla\nPantalla i √†udio\nPantalla i √†udio intern" | dmenu_col -c -l 5 -p "Qu√® vols fer?")
	case "$tria" in
		"Micr√≤fon") audiomicro ;;
		"Doble √†udio") audiodoble ;;
		"Pantalla") pantalla ;;
		"Pantalla i √†udio") pantallaiso ;;
		"Pantalla i √†udio intern") pantallaisointern ;;
		*) [ -f /tmp/recordpid ] && mata ;;
	esac
}

DIR="$HOME"
[ -n "$1" ] && [ ! -d "$1" ] && notify-send "‚ùóÔ∏è Error en enregistrar" "El directori $1 no existeix!" && exit 1
[ -d "$1" ] && DIR="$1"
echo "$1 $DIR"
([ -f /tmp/recordpid ] && mata) || pregunta
