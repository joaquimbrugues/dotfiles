#!/bin/sh
# This script reads the output of LLIMA_FIFO and updates it into the contents to be parsed by lemonbar
# The pipe LLIMA_FIFO is previously fed with the output of several modules, see the script llima-bar

. $HOME/.local/share/global-style

#Define click actions
cpu_action1='notify-send "üî• Processos CPU-intensius" "$(list-cpu-processes)"'
cpu_action3='notify-send "üíª M√≤dul de CPU" "\- Mostra √∫s de CPU i la temperatura del nucli.\n\- Clica per mostrar els processos que ocupen m√©s temps del processador"'
mem_action1='notify-send "üî• Processos RAM-intensius" "$(list-ram-processes)"'
mem_action3='notify-send "üß† M√≤dul de mem√≤ria" "\- Mostra mem√≤ria usada/total.\n\- Clica per veure els processos que consumeixen m√©s mem√≤ria."'
wstat_action1='$TERMINAL -e nmtui'
wstat_action3='notify-send "üåê M√≤dul internet" "\- Mostra si hi ha connexi√≥ a internet.\n\- Clica per editar la connexi√≥."'
vol_action1='pactl set-sink-mute 0 toggle && echo "V" > $LLIMA_FIFO'
vol_action2='pavucontrol'
vol_action3='notify-send "üîâ M√≤dul de volum" "\- Mostra el volum i si est√† silenciat.\n\- Clica per silenciar.\n\- Fes servir la roda del ratol√≠ per pujar o baixar el volum."'
vol_action4='amixer sset Master 2%+ && echo "V" > $LLIMA_FIFO'
vol_action5='amixer sset Master 2%- && echo "V" > $LLIMA_FIFO'
bat_action3='notify-send "üîã M√≤dul de bateria" "\- Mostra la c√†rrega actual."'
date_action1='notify-send "üóì $(cal)"'
date_action3='notify-send "‚åö Data i hora" "\- Mostra la data i hora actuals.\n\- Clica per mostrar el calendari del mes actual."'
wm_action3='notify-send "üñ• Escriptoris" "\- Clica sobre un escriptori anar-hi."'
bluetooth_action1='blueman-manager && echo -e "L\nV" >$LLIMA_FIFO'
bluetooth_action2='bluetoothctl power off && echo "L" > $LLIMA_FIFO'
bluetooth_action3='notify-send "üì° M√≤dul de Bluetooth" "\- Apareix nom√©s si el connector de Bluetooth est√† enc√®s.\n\- Clica per obrir el blueman-manager.\n\- Fes clic amb la roda del ratol√≠ per apagar el m√≤dul de Bluetooth."'
launcher_action1='dmenu_col_run -c -l 10'
launcher_action2='dmenu-quit'
launcher_action3='notify-send "üêß Men√∫ principal" "\- Clica per obrir el men√∫ de les aplicacions.\n\- Fes clic amb la roda del ratol√≠ per apagar/reiniciar/tancar la sessi√≥."'
record_action1='enregistra'
record_action3='notify-send "üéô M√≤dul de gravadora" "\- Fes clic per aturar la gravaci√≥."'
mail_action1='$TERMINAL -e neomutt ; echo "M" >$LLIMA_FIFO'
mail_action2='mailsync && echo "M" >$LLIMA_FIFO'
mail_action3='notify-send "üì´ M√≤dul del correu" "\- Mostra correus sense llegir.\n\- Fes clic per obrir el client de correu.\n\- Fes clic amb la roda del ratol√≠ per actualitzar la safata del correu."'
crypto_action3='notify-send "üí∏ M√≤dul de criptomonedes" "\- Mostra intercanvi actual de LBC."'

launcher=" %{A:${launcher_action1}:}%{A2:${launcher_action2}:}%{A3:${launcher_action3}:}%{+u} üêß %{-u}%{A}%{A}%{A}"

while read -r line ; do
	case $line in
		C*)
			#cpu_usage module output
			cpu=" %{A:${cpu_action1}:}%{A3:${cpu_action3}:}%{+u}${line#?}%{-u}%{A}%{A} "
			;;
		R*)
			#memory module output
			memory=" %{A:${mem_action1}:}%{A3:${mem_action3}:}%{+u}üß† ${line#?}%{-u}%{A}%{A} "
			;;
		L*)
			bluetooth=
			[ "$(bluetoothctl show | grep -i powered | awk '{print $2}')" = "yes" ] && bluetooth=" %{A:${bluetooth_action1}:}%{A2:${bluetooth_action2}:}%{A3:${bluetooth_action3}:}%{+u}üîµ%{-u}%{A}%{A}%{A} "
			;;
		E*)
			record=
			[ "${#line}" -gt "1" ] && record=" %{A:${record_action1}:}%{A3:${record_action3}:}%{+u}${line#?}%{-u}%{A}%{A} "
			;;
		I*)
			#wstat module output
			wstat=" %{A:${wstat_action1}:}%{A3:${wstat_action3}:}%{+u}${line#?}%{-u}%{A}%{A} "
			;;
		V*)
			#volume output
			vol_status="$(amixer get Master)"
			vol=$(echo "$vol_status" | grep "\[[0-9]\+%\]" | grep -Pom 1 "[0-9]+%")
			case $vol_status in
				*\[off\]*) message="üîá ($vol)" ;;
				*\[on\]*) num="${vol:0:-1}"
					if [ "$num" -gt "50" ]; then
						icon="üîä"
					else
						icon="üîâ"
					fi
					message="$icon $vol" ;;
			esac
			volume=" %{A:${vol_action1}:}%{A2:${vol_action2}:}%{A3:${vol_action3}:}%{A4:${vol_action4}:}%{A5:${vol_action5}:}%{+u}${message}%{-u}%{A}%{A}%{A}%{A}%{A} "
			;;
		B*)
			#battery module output
			bat=" %{A3:${bat_action3}:}%{+u}${line#?}%{-u}%{A} "
			;;
		D*)
			#date module output
			date=" %{A:${date_action1}:}%{A3:${date_action3}:}%{+u}${line#?}%{-u}%{A}%{A} "
			;;
		M*)
			#e-mail inbox count
			MAILBOX="$HOME/.local/share/mail"
			NUM_MAIL=$(find $MAILBOX/*/INBOX/new -type f | wc -l)
			if [ "$NUM_MAIL" -gt 0 ]; then
				mail=" %{A:${mail_action1}:}%{A2:${mail_action2}:}%{A3:${mail_action3}:}%{+u}üì¨ ${NUM_MAIL}%{-u}%{A}%{A}%{A} "
			else
				mail=""
			fi
			;;
		Y*)
			#Crypto module
			crypto=" %{A3:${crypto_action3}:}%{+u}üí∏ ${line#?}%{-u}%{A} "
		W*)
			#BSPWM state
			wm=
			IFS=':'
			set -- ${line#?}
			monitor_focused=
			while [ $# -gt 0 ] ; do
				item=$1
				name=${item#?}
				case $item in
					[M]*)
						monitor_focused=2
						;;
					[m]*)
						monitor_focused=1
						;;
					[OF]*)
						#Occupied or free focused desktop
						[ $monitor_focused -eq 2 ] && wm="${wm} %{F${COLOR_FOREGROUND_SELECTED}}%{B${COLOR_BACKGROUND_SELECTED}}%{U${COLOR_UNDERLINE_SELECTED}}%{+u} ${name} %{-u}%{U-}%{B-}%{F-}"
						[ $monitor_focused -eq 1 ] && wm="${wm} %{A:bspc desktop -f ${name}:}%{+u} ${name} %{-u}%{A}"
						;;
					[o]*)
						#Occupied non-focused desktop
						wm="${wm} %{A:bspc desktop -f ${name}:}%{+u} ${name} %{-u}%{A}"
						;;
					*)
						;;
				esac
				shift
			done
			wm="%{A3:${wm_action3}:}${wm}%{A}"
			;;
		*)
			;;
	esac
	printf "%s\n" "%{l}${launcher}${wm}%{r}${record}${cpu}${memory}${mail}${crypto}${wstat}${volume}${bluetooth}${bat}${date}"
done
