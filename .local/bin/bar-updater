#!/bin/sh
# This script reads the output of LLIMA_FIFO and updates it into the contents to be parsed by lemonbar
# The pipe LLIMA_FIFO is previously fed with the output of several modules, see the script llima-bar

. $HOME/.local/share/global-style

#Define click actions
cpu_action1='notify-send "üî• Processos CPU-intensius" "$(list-cpu-processes)"'
cpu_action3='notify-send "üíª M√≤dul de CPU" "\- Mostra √∫s de CPU i la temperatura del nucli.\n\- Clica per mostrar els processos que ocupen m√©s temps del processador"'
mem_action1='notify-send "üî• Processos RAM-intensius" "$(list-ram-processes)"'
mem_action3='notify-send "üß† M√≤dul de mem√≤ria" "\- Mostra mem√≤ria usada/total.\n\- Clica per veure els processos que consumeixen m√©s mem√≤ria."'
wstat_action1='$TERMINAL -e nmtui'
wstat_action3='notify-send "üåê M√≤dul internet" "\- Mostra si hi ha connexi√≥ a internet.\n\- Clica per editar la connexi√≥."'
vol_action1='pactl set-sink-mute 0 toggle && echo "V" > $LLIMA_FIFO'
vol_action2='pavucontrol'
vol_action3='notify-send "üîâ M√≤dul de volum" "\- Mostra el volum i si est√† silenciat.\n\- Clica per silenciar.\n\- Fes servir la roda del ratol√≠ per pujar o baixar el volum."'
vol_action4='amixer sset Master 2%+ && echo "V" > $LLIMA_FIFO'
vol_action5='amixer sset Master 2%- && echo "V" > $LLIMA_FIFO'
bat_action3='notify-send "üîã M√≤dul de bateria" "\- Mostra la c√†rrega actual."'
date_action1='notify-send "üóì $(cal)"'
date_action3='notify-send "‚åö Data i hora" "\- Mostra la data i hora actuals.\n\- Clica per mostrar el calendari del mes actual."'
wm_action3='notify-send "üñ• Escriptoris" "\- Clica sobre un escriptori anar-hi."'
bluetooth_action1='blueman-manager && echo -e "L\nV" >$LLIMA_FIFO'
bluetooth_action3='notify-send "M√≤dul de Bluetooth" "\- Apareix nom√©s si el connector de Bluetooth est√† enc√®s.\n\- Clica per obrir el blueman-manager."'
launcher_action1='dmenu_col_run -c -l 10'
launcher_action2='dmenu-quit'
launcher_action3='notify-send "üêß Men√∫ principal" "\- Clica per obrir el men√∫ de les aplicacions.\n\- Fes clic amb la roda del ratol√≠ per apagar/reiniciar/tancar la sessi√≥."'

launcher=" %{A:${launcher_action1}:}%{A2:${launcher_action2}:}%{A3:${launcher_action3}:}%{+u} P %{-u}%{A}%{A}%{A}"

while read -r line ; do
	case $line in
		C*)
			#cpu_usage module output
			cpu=" %{A:${cpu_action1}:}%{A3:${cpu_action3}:}%{+u}${line#?}%{-u}%{A}%{A} "
			;;
		R*)
			#memory module output
			memory=" %{A:${mem_action1}:}%{A3:${mem_action3}:}%{+u}RAM: ${line#?}%{-u}%{A}%{A} "
			;;
		L*)
			bluetooth=
			[ "$(bluetoothctl show | grep -i powered | awk '{print $2}')" = "yes" ] && bluetooth=" %{A:${bluetooth_action1}:}%{A3:${bluetooth_action3}:}%{+u}Bluetooth on%{-u}%{A}%{A} "
			;;
		I*)
			#wstat module output
			wstat=" %{A:${wstat_action1}:}%{A3:${wstat_action3}:}%{+u}${line#?}%{-u}%{A}%{A} "
			;;
		V*)
			#volume output
			vol_status="$(amixer get Master)"
			vol=$(echo "$vol_status" | grep "\[[0-9]\+%\]" | grep -Pom 1 "[0-9]+%")
			case $vol_status in
				*\[off\]*) message="SIL ($vol%)" ;;
				*\[on\]*) message="VOL $vol%" ;;
			esac
			volume=" %{A:${vol_action1}:}%{A2:${vol_action2}:}%{A3:${vol_action3}:}%{A4:${vol_action4}:}%{A5:${vol_action5}:}%{+u}${message}%{-u}%{A}%{A}%{A}%{A}%{A} "
			;;
		B*)
			#battery module output
			bat=" %{A3:${bat_action3}:}%{+u}BAT ${line#?}%%{-u}%{A} "
			;;
		D*)
			#date module output
			date=" %{A:${date_action1}:}%{A3:${date_action3}:}%{+u}${line#?}%{-u}%{A}%{A} "
			;;
		W*)
			#BSPWM state
			wm=
			IFS=':'
			set -- ${line#?}
			monitor_focused=
			while [ $# -gt 0 ] ; do
				item=$1
				name=${item#?}
				case $item in
					[M]*)
						monitor_focused=2
						;;
					[m]*)
						monitor_focused=1
						;;
					[OF]*)
						#Occupied or free focused desktop
						[ $monitor_focused -eq 2 ] && wm="${wm} %{F${COLOR_FOREGROUND_SELECTED}}%{B${COLOR_BACKGROUND_SELECTED}}%{U${COLOR_UNDERLINE_SELECTED}}%{+u} ${name} %{-u}%{U-}%{B-}%{F-}"
						[ $monitor_focused -eq 1 ] && wm="${wm} %{A:bspc desktop -f ${name}:}%{+u} ${name} %{-u}%{A}"
						;;
					[o]*)
						#Occupied non-focused desktop
						wm="${wm} %{A:bspc desktop -f ${name}:}%{+u} ${name} %{-u}%{A}"
						;;
					*)
						;;
				esac
				shift
			done
			wm="%{A3:${wm_action3}:}${wm}%{A}"
			;;
		*)
			;;
	esac
	printf "%s\n" "%{l}${launcher}${wm}%{r}${cpu}${memory}${mail}${wstat}${volume}${bluetooth}${bat}${date}"
done
